# 开发与部署指南

<cite>
**本文档引用文件**   
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md)
- [application.properties](file://src/main/resources/application.properties)
- [NewBeeMallApplication.java](file://src/main/java/ltd/newbee/mall/NewBeeMallApplication.java)
- [NeeBeeMallWebMvcConfigurer.java](file://src/main/java/ltd/newbee/mall/config/NeeBeeMallWebMvcConfigurer.java)
- [pom.xml](file://pom.xml)
- [newbee_mall_schema.sql](file://src/main/resources/newbee_mall_schema.sql)
- [API.md](file://docs/API.md)
- [README.md](file://README.md)
- [FAQ.md](file://docs/FAQ.md)
</cite>

## 目录
1. [开发环境搭建](#开发环境搭建)
2. [代码调试技巧](#代码调试技巧)
3. [新增功能模块标准流程](#新增功能模块标准流程)
4. [前后端联调方法](#前后端联调方法)
5. [单元测试与集成测试](#单元测试与集成测试)
6. [打包与部署](#打包与部署)
7. [生产环境配置](#生产环境配置)
8. [Nginx反向代理配置](#nginx反向代理配置)
9. [SSL证书配置](#ssl证书配置)
10. [监控与日志查看](#监控与日志查看)
11. [CI/CD集成思路](#cicd集成思路)

## 开发环境搭建

### 1. 安装必要软件

#### 1.1 安装JDK
安装JDK 1.8或以上版本，并配置环境变量。

验证安装：
```bash
java -version
```

#### 1.2 安装Maven
安装Maven 3.x，配置环境变量。

验证安装：
```bash
mvn -version
```

推荐配置阿里云镜像（修改`settings.xml`）：
```xml
<mirror>
  <id>aliyun</id>
  <mirrorOf>central</mirrorOf>
  <name>Aliyun Maven</name>
  <url>https://maven.aliyun.com/repository/public</url>
</mirror>
```

#### 1.3 安装MySQL
安装MySQL 5.7或以上版本。

创建数据库：
```sql
CREATE DATABASE newbee_mall_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

#### 1.4 安装IDE
推荐使用IntelliJ IDEA或Eclipse。

### 2. 克隆项目
```bash
git clone https://github.com/newbee-ltd/newbee-mall.git
cd newbee-mall
```

### 3. 导入数据库
执行项目中的SQL脚本：
```bash
mysql -u root -p newbee_mall_db < src/main/resources/newbee_mall_schema.sql
```

### 4. 配置项目
修改`src/main/resources/application.properties`：
```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/newbee_mall_db?useUnicode=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&autoReconnect=true&useSSL=false&allowMultiQueries=true
spring.datasource.username=root
spring.datasource.password=你的密码

# 服务器端口
server.port=28089
```

**Section sources**
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#开发环境搭建)
- [application.properties](file://src/main/resources/application.properties#L6-L12)

## 代码调试技巧

### 1. 热部署配置
项目已配置Thymeleaf模板缓存为false，实现页面热更新：
```properties
spring.thymeleaf.cache=false
```

对于Java代码修改，建议添加spring-boot-devtools依赖以实现热部署。

### 2. 日志调试
在`application.properties`中配置日志级别：
```properties
logging.level.ltd.newbee.mall=DEBUG
logging.level.ltd.newbee.mall.dao=DEBUG
```

### 3. MyBatis SQL调试
启用MyBatis SQL日志输出：
```properties
mybatis.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

### 4. 断点调试
在IDE中设置断点，通过以下方式启动调试模式：
- **IntelliJ IDEA**: 点击"Debug"按钮运行`NewBeeMallApplication`
- **命令行**: `mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005"`

**Section sources**
- [application.properties](file://src/main/resources/application.properties#L7)
- [FAQ.md](file://docs/FAQ.md#开发调试相关)

## 新增功能模块标准流程

### 1. 添加新控制器
创建新的Controller类，例如添加用户反馈功能：
```java
@Controller
@RequestMapping("/feedback")
public class FeedbackController {
    
    @Resource
    private FeedbackService feedbackService;
    
    @GetMapping("/list")
    public String listPage(HttpServletRequest request) {
        // 业务逻辑
        return "mall/feedback/list";
    }
    
    @PostMapping("/submit")
    @ResponseBody
    public Result submitFeedback(@RequestBody Feedback feedback) {
        // 提交反馈
        return Result.success();
    }
}
```

### 2. 创建服务类
定义服务接口及实现：

**服务接口**：
```java
public interface FeedbackService {
    Boolean saveFeedback(Feedback feedback);
    PageResult getFeedbackPage(PageQueryUtil pageUtil);
}
```

**服务实现**：
```java
@Service
public class FeedbackServiceImpl implements FeedbackService {
    
    @Resource
    private FeedbackMapper feedbackMapper;
    
    @Override
    @Transactional
    public Boolean saveFeedback(Feedback feedback) {
        if (feedback == null) {
            return false;
        }
        return feedbackMapper.insertSelective(feedback) > 0;
    }
    
    @Override
    public PageResult getFeedbackPage(PageQueryUtil pageUtil) {
        List<Feedback> feedbackList = feedbackMapper.findFeedbackList(pageUtil);
        int total = feedbackMapper.getTotalFeedbacks(pageUtil);
        return new PageResult(feedbackList, total, pageUtil.getLimit(), pageUtil.getPage());
    }
}
```

### 3. 创建Mapper
**Mapper接口**：
```java
public interface FeedbackMapper {
    int insertSelective(Feedback record);
    List<Feedback> findFeedbackList(Map<String, Object> params);
    int getTotalFeedbacks(Map<String, Object> params);
}
```

**Mapper XML**：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ltd.newbee.mall.dao.FeedbackMapper">
    
    <resultMap id="BaseResultMap" type="ltd.newbee.mall.entity.Feedback">
        <id column="feedback_id" jdbcType="BIGINT" property="feedbackId" />
        <result column="user_id" jdbcType="BIGINT" property="userId" />
        <result column="content" jdbcType="VARCHAR" property="content" />
        <result column="status" jdbcType="TINYINT" property="status" />
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    </resultMap>
    
    <insert id="insertSelective" parameterType="ltd.newbee.mall.entity.Feedback">
        insert into tb_feedback
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="feedbackId != null">
                feedback_id,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="content != null">
                content,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="feedbackId != null">
                #{feedbackId,jdbcType=BIGINT},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=BIGINT},
            </if>
            <if test="content != null">
                #{content,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=TINYINT},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>
    
    <select id="findFeedbackList" resultMap="BaseResultMap">
        SELECT * FROM tb_feedback
        <where>
            <if test="status != null and status != ''">
                and status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{page}, #{limit}
    </select>
    
    <select id="getTotalFeedbacks" resultType="int">
        SELECT count(*) FROM tb_feedback
        <where>
            <if test="status != null and status != ''">
                and status = #{status}
            </if>
        </where>
    </select>
</mapper>
```

### 4. 创建实体类
```java
public class Feedback {
    private Long feedbackId;
    private Long userId;
    private String content;
    private Byte status;
    private Date createTime;
    private Date updateTime;
    
    // getter和setter方法
}
```

### 5. 创建数据库表
在数据库中创建反馈表：
```sql
CREATE TABLE `tb_feedback` (
  `feedback_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '反馈ID',
  `user_id` bigint(20) NOT NULL COMMENT '用户ID',
  `content` varchar(500) NOT NULL COMMENT '反馈内容',
  `status` tinyint(4) NOT NULL DEFAULT '0' COMMENT '状态 0-未处理 1-已处理',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`feedback_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户反馈表';
```

**Section sources**
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#常用开发任务)
- [newbee_mall_schema.sql](file://src/main/resources/newbee_mall_schema.sql)

## 前后端联调方法

### 1. API接口规范
项目采用统一的返回结果格式：
```json
{
  "resultCode": 200,
  "message": "success",
  "data": {}
}
```

### 2. 接口测试工具
使用Postman或curl测试API接口：

**获取商品详情**：
```bash
curl -X GET "http://localhost:28089/goods/detail/1"
```

**添加购物车**：
```bash
curl -X POST "http://localhost:28089/shop-cart" \
  -H "Content-Type: application/json" \
  -d '{"goodsId": 1, "goodsCount": 2}'
```

**用户登录**：
```bash
curl -X POST "http://localhost:28089/login" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "loginName=testuser&password=123456&verifyCode=1234"
```

### 3. 前后端数据格式约定
- **请求参数**：GET请求使用查询参数，POST请求使用JSON或表单数据
- **响应格式**：统一使用Result对象包装
- **错误处理**：使用统一的异常处理机制

### 4. 跨域问题处理
如需前后端分离开发，可在Controller上添加CORS注解：
```java
@CrossOrigin(origins = "*")
@RestController
@RequestMapping("/api")
public class ApiController {
    // API接口
}
```

**Section sources**
- [API.md](file://docs/API.md)
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#开发规范)

## 单元测试与集成测试

### 1. 单元测试
使用JUnit 5进行单元测试：

```java
@SpringBootTest
public class FeedbackServiceTest {
    
    @Resource
    private FeedbackService feedbackService;
    
    @Resource
    private FeedbackMapper feedbackMapper;
    
    @Test
    public void testSaveFeedback() {
        Feedback feedback = new Feedback();
        feedback.setUserId(1L);
        feedback.setContent("测试反馈内容");
        
        Boolean result = feedbackService.saveFeedback(feedback);
        assertTrue(result);
        
        Feedback savedFeedback = feedbackMapper.selectByPrimaryKey(feedback.getFeedbackId());
        assertNotNull(savedFeedback);
        assertEquals("测试反馈内容", savedFeedback.getContent());
    }
    
    @Test
    public void testGetFeedbackPage() {
        PageQueryUtil pageUtil = new PageQueryUtil();
        pageUtil.setPage(1);
        pageUtil.setLimit(10);
        
        PageResult pageResult = feedbackService.getFeedbackPage(pageUtil);
        assertNotNull(pageResult);
        assertTrue(pageResult.getTotal() >= 0);
    }
}
```

### 2. 集成测试
测试完整的业务流程：

```java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@TestPropertySource(locations = "classpath:application-test.properties")
class OrderIntegrationTest {
    
    @LocalServerPort
    private int port;
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    public void testCreateOrder() {
        // 准备测试数据
        Long userId = 1L;
        Long addressId = 1L;
        String cartItemIds = "1,2";
        
        // 发送创建订单请求
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        
        MultiValueMap<String, String> map = new LinkedMultiValueMap<>();
        map.add("addressId", addressId.toString());
        map.add("cartItemIds", cartItemIds);
        
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(map, headers);
        
        ResponseEntity<Result> response = restTemplate.postForEntity(
            "http://localhost:" + port + "/saveOrder",
            request,
            Result.class
        );
        
        // 验证响应
        assertEquals(HttpStatus.OK, response.getStatusCode());
        assertEquals(200, response.getBody().getResultCode());
    }
}
```

### 3. 测试配置
创建`application-test.properties`用于测试环境：
```properties
# 测试数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/newbee_mall_test?useUnicode=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&autoReconnect=true&useSSL=false&allowMultiQueries=true
spring.datasource.username=root
spring.datasource.password=123456

# 关闭缓存
spring.thymeleaf.cache=false

# 日志配置
logging.level.ltd.newbee.mall=DEBUG
```

### 4. 运行测试
```bash
# 运行所有测试
mvn test

# 运行指定测试类
mvn test -Dtest=FeedbackServiceTest

# 运行指定测试方法
mvn test -Dtest=FeedbackServiceTest#testSaveFeedback
```

**Section sources**
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#测试指南)
- [pom.xml](file://pom.xml)

## 打包与部署

### 1. 打包项目
```bash
# 清理并打包，跳过测试
mvn clean package -DskipTests

# 或者运行测试后打包
mvn clean install
```

打包完成后，可在`target`目录下找到生成的JAR文件：
```
target/newbee-mall-1.0.0-SNAPSHOT.jar
```

### 2. 服务器环境准备
- 安装JDK 1.8+
- 安装MySQL 5.7+
- 创建数据库并导入数据
- 安装必要的系统工具（如nohup）

### 3. 上传并运行
```bash
# 上传JAR包到服务器
scp target/newbee-mall-1.0.0-SNAPSHOT.jar user@server:/app/

# SSH登录服务器
ssh user@server

# 创建日志目录
mkdir -p /app/logs

# 运行项目（后台运行）
nohup java -jar /app/newbee-mall-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod > /app/logs/app.log 2>&1 &

# 查看进程
ps aux | grep newbee-mall

# 查看日志
tail -f /app/logs/app.log
```

### 4. 启动脚本
创建启动脚本`start.sh`：
```bash
#!/bin/bash

APP_NAME="newbee-mall-1.0.0-SNAPSHOT.jar"
APP_PATH="/app/$APP_NAME"
LOG_PATH="/app/logs/app.log"
PID_FILE="/app/app.pid"

case "$1" in
    start)
        if [ -f "$PID_FILE" ]; then
            PID=$(cat $PID_FILE)
            if ps -p $PID > /dev/null 2>&1; then
                echo "Application is already running (PID: $PID)"
                exit 1
            fi
        fi
        
        nohup java -jar $APP_PATH --spring.profiles.active=prod > $LOG_PATH 2>&1 &
        echo $! > $PID_FILE
        echo "Application started (PID: $!)"
        ;;
    stop)
        if [ -f "$PID_FILE" ]; then
            PID=$(cat $PID_FILE)
            if ps -p $PID > /dev/null 2>&1; then
                kill $PID
                rm -f $PID_FILE
                echo "Application stopped (PID: $PID)"
            else
                echo "No application is running"
                rm -f $PID_FILE
            fi
        else
            echo "No application is running"
        fi
        ;;
    restart)
        $0 stop
        sleep 2
        $0 start
        ;;
    status)
        if [ -f "$PID_FILE" ]; then
            PID=$(cat $PID_FILE)
            if ps -p $PID > /dev/null 2>&1; then
                echo "Application is running (PID: $PID)"
            else
                echo "Application is not running"
                rm -f $PID_FILE
            fi
        else
            echo "Application is not running"
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
```

赋予执行权限并使用：
```bash
chmod +x start.sh
./start.sh start
./start.sh stop
./start.sh restart
./start.sh status
```

**Section sources**
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#部署指南)
- [FAQ.md](file://docs/FAQ.md#部署运维相关)

## 生产环境配置

### 1. 生产配置文件
创建`application-prod.properties`：
```properties
# 服务器配置
server.port=8080
server.servlet.context-path=/mall

# 数据库连接池配置
spring.datasource.hikari.minimum-idle=10
spring.datasource.hikari.maximum-pool-size=50
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.idle-timeout=600000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.auto-commit=true

# 日志配置
logging.level.root=INFO
logging.level.ltd.newbee.mall=INFO
logging.file.path=/app/logs
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{50} - %msg%n

# Session配置
server.servlet.session.timeout=30m

# 文件上传配置
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=100MB

# 缓存配置
spring.thymeleaf.cache=true
spring.thymeleaf.enabled=true

# 安全配置
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=always
```

### 2. JVM参数优化
启动时添加JVM参数：
```bash
java -Xms512m -Xmx1024m \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:G1HeapRegionSize=16m \
     -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -Xloggc:/app/logs/gc.log \
     -jar newbee-mall-1.0.0-SNAPSHOT.jar \
     --spring.profiles.active=prod
```

### 3. 数据库优化
- 为常用查询字段添加索引
- 配置合理的连接池大小
- 定期备份数据库

### 4. 安全配置
- 使用HTTPS传输
- 定期更新密码
- 限制管理后台访问IP
- 启用防火墙

**Section sources**
- [application.properties](file://src/main/resources/application.properties)
- [FAQ.md](file://docs/FAQ.md#部署运维相关)

## Nginx反向代理配置

### 1. Nginx安装
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

### 2. 配置反向代理
创建配置文件`/etc/nginx/sites-available/newbee-mall`：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 访问日志
    access_log /var/log/nginx/newbee-mall.access.log;
    error_log /var/log/nginx/newbee-mall.error.log;
    
    # 静态资源缓存
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        root /app/static;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options nosniff;
    }
    
    # 字体文件
    location ~* \.(woff|woff2|ttf|eot)$ {
        root /app/static;
        expires 1y;
        add_header Access-Control-Allow-Origin "*";
    }
    
    # 主应用代理
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 代理超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
    
    # 健康检查
    location /actuator/health {
        proxy_pass http://localhost:8080/actuator/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3. 启用配置
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/newbee-mall /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 设置开机启动
sudo systemctl enable nginx
```

### 4. HTTPS配置
```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL证书
    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;
    
    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 其他配置同HTTP
    include /etc/nginx/sites-available/newbee-mall-common;
}
```

**Section sources**
- [FAQ.md](file://docs/FAQ.md#部署运维相关)

## SSL证书配置

### 1. 使用Let's Encrypt免费证书
安装Certbot：
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx
```

获取SSL证书：
```bash
sudo certbot --nginx -d your-domain.com
```

### 2. 手动配置SSL证书
将证书文件上传到服务器：
```bash
# 上传证书文件
scp your-domain.crt your-domain.key user@server:/etc/ssl/

# 设置权限
sudo chmod 600 /etc/ssl/your-domain.key
sudo chmod 644 /etc/ssl/your-domain.crt
```

### 3. 自动续期配置
添加定时任务自动续期：
```bash
# 编辑crontab
crontab -e

# 添加续期任务
0 12 * * * /usr/bin/certbot renew --quiet
```

### 4. Tomcat风格的JKS证书
如果需要JKS格式证书：
```bash
# 将PEM转换为PKCS12
openssl pkcs12 -export -in your-domain.crt -inkey your-domain.key -out domain.p12 -name tomcat -CAfile ca-bundle.crt -caname root

# 将PKCS12转换为JKS
keytool -importkeystore -deststorepass changeit -destkeypass changeit -destkeystore domain.jks -srckeystore domain.p12 -srcstoretype PKCS12 -srcstorepass changeit -alias tomcat
```

在`application-prod.properties`中配置：
```properties
server.ssl.key-store-type=JKS
server.ssl.key-store=/path/to/domain.jks
server.ssl.key-store-password=changeit
server.ssl.key-alias=tomcat
```

**Section sources**
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md#部署指南)
- [FAQ.md](file://docs/FAQ.md#部署运维相关)

## 监控与日志查看

### 1. 日志文件管理
项目日志输出到指定目录：
```bash
# 查看应用日志
tail -f /app/logs/app.log

# 查看GC日志
tail -f /app/logs/gc.log

# 查看Nginx访问日志
tail -f /var/log/nginx/newbee-mall.access.log

# 查看Nginx错误日志
tail -f /var/log/nginx/newbee-mall.error.log
```

### 2. 日志轮转配置
创建日志轮转配置`/etc/logrotate.d/newbee-mall`：
```bash
/app/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        /bin/kill -USR1 `cat /app/app.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

### 3. 系统监控
使用系统工具监控资源使用情况：
```bash
# 实时监控系统资源
top

# 监控内存使用
free -h

# 监控磁盘使用
df -h

# 监控网络连接
netstat -tlnp

# 监控进程
ps aux | grep java
```

### 4. 应用健康检查
通过Actuator端点监控应用状态：
```bash
# 健康检查
curl http://localhost:8080/actuator/health

# 获取应用信息
curl http://localhost:8080/actuator/info

# 获取环境信息
curl http://localhost:8080/actuator/env

# 获取度量信息
curl http://localhost:8080/actuator/metrics
```

### 5. 日志分析
使用常用命令分析日志：
```bash
# 统计错误日志
grep -c "ERROR" /app/logs/app.log

# 查找特定异常
grep -n "Exception" /app/logs/app.log | tail -10

# 统计访问量
grep "GET /" /var/log/nginx/newbee-mall.access.log | wc -l

# 查找慢请求
grep "duration>1000" /app/logs/app.log
```

**Section sources**
- [FAQ.md](file://docs/FAQ.md#部署运维相关)
- [application.properties](file://src/main/resources/application.properties)

## CI/CD集成思路

### 1. GitLab CI/CD配置
创建`.gitlab-ci.yml`：
```yaml
stages:
  - build
  - test
  - package
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository/
    - target/

build:
  stage: build
  script:
    - mvn compile
  only:
    - main

test:
  stage: test
  script:
    - mvn test
  only:
    - main

package:
  stage: package
  script:
    - mvn clean package -DskipTests
    - cp target/*.jar artifacts/newbee-mall.jar
  artifacts:
    paths:
      - artifacts/newbee-mall.jar
  only:
    - main

deploy-production:
  stage: deploy
  script:
    - scp artifacts/newbee-mall.jar user@production-server:/app/
    - ssh user@production-server "cd /app && ./start.sh restart"
  only:
    - tags
```

### 2. GitHub Actions配置
创建`.github/workflows/deploy.yml`：
```yaml
name: Deploy Application

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    
    - name: Build with Maven
      run: mvn -B package --file pom.xml -DskipTests
    
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: newbee-mall-jar
        path: target/*.jar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v2
      with:
        name: newbee-mall-jar
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /app
          mv newbee-mall-*.jar newbee-mall-backup.jar || true
          mv artifact/*.jar newbee-mall.jar
          ./start.sh restart
```

### 3. Jenkins Pipeline配置
创建Jenkinsfile：
```groovy
pipeline {
    agent any
    
    environment {
        APP_NAME = 'newbee-mall'
        APP_PORT = 8080
        SERVER_USER = 'deploy'
        SERVER_HOST = 'your-server.com'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn test'
            }
        }
        
        stage('Package') {
            steps {
                sh 'mvn package -DskipTests'
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'main') {
                        sh """
                            scp target/${APP_NAME}-*.jar ${SERVER_USER}@${SERVER_HOST}:/app/
                            ssh ${SERVER_USER}@${SERVER_HOST} "cd /app && ./start.sh restart"
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'Deployment successful!'
            slackSend channel: '#deployments', message: "✅ ${APP_NAME} deployed successfully to production!"
        }
        failure {
            echo 'Deployment failed!'
            slackSend channel: '#alerts', message: "❌ ${APP_NAME} deployment failed!"
        }
    }
}
```

### 4. Docker部署方案
创建`Dockerfile`：
```dockerfile
FROM openjdk:8-jre-alpine

# 创建应用目录
RUN mkdir -p /app

# 添加应用
COPY target/newbee-mall-*.jar /app/app.jar

# 暴露端口
EXPOSE 8080

# 创建日志目录
RUN mkdir -p /app/logs

# 启动应用
ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "/app/app.jar"]

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1
```

创建`docker-compose.yml`：
```yaml
version: '3.8'

services:
  newbee-mall:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/newbee_mall_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=123456
    volumes:
      - ./logs:/app/logs
    depends_on:
      - mysql
    restart: unless-stopped

  mysql:
    image: mysql:5.7
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=newbee_mall_db
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped

volumes:
  mysql_data:
```

**Section sources**
- [pom.xml](file://pom.xml)
- [DEVELOPMENT.md](file://docs/DEVELOPMENT.md)