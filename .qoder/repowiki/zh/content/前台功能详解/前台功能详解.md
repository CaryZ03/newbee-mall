# 前台功能详解

<cite>
**本文档引用文件**  
- [IndexController.java](file://src/main/java/ltd/newbee/mall/controller/mall/IndexController.java)
- [GoodsController.java](file://src/main/java/ltd/newbee/mall/controller/mall/GoodsController.java)
- [ShoppingCartController.java](file://src/main/java/ltd/newbee/mall/controller/mall/ShoppingCartController.java)
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java)
- [PersonalController.java](file://src/main/java/ltd/newbee/mall/controller/mall/PersonalController.java)
- [NewBeeMallGoodsDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallGoodsDetailVO.java)
- [NewBeeMallIndexCategoryVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallIndexCategoryVO.java)
- [NewBeeMallShoppingCartItemVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallShoppingCartItemVO.java)
- [NewBeeMallLoginInterceptor.java](file://src/main/java/ltd/newbee/mall/interceptor/NewBeeMallLoginInterceptor.java)
- [NeeBeeMallWebMvcConfigurer.java](file://src/main/java/ltd/newbee/mall/config/NeeBeeMallWebMvcConfigurer.java)
- [NewBeeMallShoppingCartServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallShoppingCartServiceImpl.java)
- [index.html](file://src/main/resources/templates/mall/index.html)
- [detail.html](file://src/main/resources/templates/mall/detail.html)
- [cart.html](file://src/main/resources/templates/mall/cart.html)
- [order-settle.html](file://src/main/resources/templates/mall/order-settle.html)
</cite>

## 目录
1. [首页展示](#首页展示)
2. [商品浏览](#商品浏览)
3. [购物车管理](#购物车管理)
4. [订单创建](#订单创建)
5. [用户个人中心](#用户个人中心)
6. [视图对象(VO)作用](#视图对象vo作用)
7. [拦截器安全机制](#拦截器安全机制)

## 首页展示

首页功能由`IndexController`控制器和`index.html`模板文件共同实现。`IndexController`的`indexPage`方法处理根路径、`/index`和`/index.html`的GET请求，从服务层获取分类、轮播图和推荐商品数据，并通过`HttpServletRequest`的`setAttribute`方法将数据传递给前端模板。

```mermaid
sequenceDiagram
participant 浏览器
participant IndexController
participant NewBeeMallCategoryService
participant NewBeeMallCarouselService
participant NewBeeMallIndexConfigService
participant index.html
浏览器->>IndexController : GET /index
IndexController->>NewBeeMallCategoryService : getCategoriesForIndex()
NewBeeMallCategoryService-->>IndexController : 返回NewBeeMallIndexCategoryVO列表
IndexController->>NewBeeMallCarouselService : getCarouselsForIndex()
NewBeeMallCarouselService-->>IndexController : 返回NewBeeMallIndexCarouselVO列表
IndexController->>NewBeeMallIndexConfigService : getConfigGoodsesForIndex()
NewBeeMallIndexConfigService-->>IndexController : 返回NewBeeMallIndexConfigGoodsVO列表
IndexController->>index.html : 设置request属性并返回"mall/index"
index.html-->>浏览器 : 渲染首页
```

**图示来源**
- [IndexController.java](file://src/main/java/ltd/newbee/mall/controller/mall/IndexController.java#L40-L55)
- [index.html](file://src/main/resources/templates/mall/index.html)

**章节来源**
- [IndexController.java](file://src/main/java/ltd/newbee/mall/controller/mall/IndexController.java#L28-L57)
- [index.html](file://src/main/resources/templates/mall/index.html)

## 商品浏览

商品浏览功能由`GoodsController`控制器和`detail.html`模板文件实现。`GoodsController`的`detailPage`方法处理`/goods/detail/{goodsId}`的GET请求，通过`NewBeeMallGoodsService`获取商品详情，并将`NewBeeMallGoods`实体转换为`NewBeeMallGoodsDetailVO`视图对象，最后传递给前端模板。

```mermaid
sequenceDiagram
participant 浏览器
participant GoodsController
participant NewBeeMallGoodsService
participant BeanUtil
participant detail.html
浏览器->>GoodsController : GET /goods/detail/123
GoodsController->>NewBeeMallGoodsService : getNewBeeMallGoodsById(123)
NewBeeMallGoodsService-->>GoodsController : 返回NewBeeMallGoods实体
GoodsController->>BeanUtil : copyProperties(goods, goodsDetailVO)
BeanUtil-->>GoodsController : 复制属性
GoodsController->>detail.html : 设置goodsDetail属性并返回"mall/detail"
detail.html-->>浏览器 : 渲染商品详情页
```

**图示来源**
- [GoodsController.java](file://src/main/java/ltd/newbee/mall/controller/mall/GoodsController.java#L74-L87)
- [detail.html](file://src/main/resources/templates/mall/detail.html)

**章节来源**
- [GoodsController.java](file://src/main/java/ltd/newbee/mall/controller/mall/GoodsController.java#L32-L90)
- [NewBeeMallGoodsDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallGoodsDetailVO.java)
- [detail.html](file://src/main/resources/templates/mall/detail.html)

## 购物车管理

购物车管理功能由`ShoppingCartController`控制器和`cart.html`模板文件实现。该功能支持购物车项的增删改查操作，通过RESTful API设计，使用不同的HTTP方法处理不同操作。

```mermaid
flowchart TD
Start([用户操作]) --> CheckLogin{"是否登录?"}
CheckLogin --> |否| RedirectToLogin["重定向到登录页"]
CheckLogin --> |是| ShowCart["显示购物车页面"]
ShowCart --> CartActions["购物车操作"]
CartActions --> AddItem["添加商品"]
CartActions --> UpdateItem["修改数量"]
CartActions --> DeleteItem["删除商品"]
CartActions --> Settle["去结算"]
AddItem --> CallAPI["调用POST /shop-cart API"]
UpdateItem --> CallUpdateAPI["调用PUT /shop-cart API"]
DeleteItem --> CallDeleteAPI["调用DELETE /shop-cart/{id} API"]
Settle --> CheckItems{"购物车是否为空?"}
Settle --> |是| ShowError["显示错误提示"]
Settle --> |否| RedirectToSettle["重定向到结算页"]
CallAPI --> Service["NewBeeMallShoppingCartService"]
CallUpdateAPI --> Service
CallDeleteAPI --> Service
Service --> DB[(数据库)]
DB -- "返回结果" --> Service
Service -- "返回JSON结果" --> Frontend["前端页面"]
Frontend --> Refresh["刷新页面"]
```

**图示来源**
- [ShoppingCartController.java](file://src/main/java/ltd/newbee/mall/controller/mall/ShoppingCartController.java)
- [cart.html](file://src/main/resources/templates/mall/cart.html)

**章节来源**
- [ShoppingCartController.java](file://src/main/java/ltd/newbee/mall/controller/mall/ShoppingCartController.java#L30-L129)
- [NewBeeMallShoppingCartServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallShoppingCartServiceImpl.java)
- [cart.html](file://src/main/resources/templates/mall/cart.html)

## 订单创建

订单创建功能由`OrderController`和`ShoppingCartController`协同完成，涉及`order-settle.html`和`my-orders.html`等多个模板文件。用户从购物车页面进入结算流程，最终生成订单。

```mermaid
sequenceDiagram
participant 浏览器
participant ShoppingCartController
participant OrderController
participant NewBeeMallOrderService
participant NewBeeMallShoppingCartService
participant order-settle.html
participant my-orders.html
浏览器->>ShoppingCartController : GET /shop-cart/settle
ShoppingCartController->>NewBeeMallShoppingCartService : getMyShoppingCartItems(userId)
NewBeeMallShoppingCartService-->>ShoppingCartController : 返回购物车项列表
ShoppingCartController->>order-settle.html : 设置价格和购物车项并返回"mall/order-settle"
order-settle.html-->>浏览器 : 渲染结算页面
浏览器->>OrderController : GET /saveOrder
OrderController->>NewBeeMallShoppingCartService : getMyShoppingCartItems(userId)
NewBeeMallShoppingCartService-->>OrderController : 返回购物车项列表
OrderController->>NewBeeMallOrderService : saveOrder(user, myShoppingCartItems)
NewBeeMallOrderService-->>OrderController : 返回订单号
OrderController->>浏览器 : 重定向到/orders/{orderNo}
浏览器->>OrderController : GET /orders/{orderNo}
OrderController->>NewBeeMallOrderService : getOrderDetailByOrderNo(orderNo, userId)
NewBeeMallOrderService-->>OrderController : 返回NewBeeMallOrderDetailVO
OrderController->>my-orders.html : 设置订单详情并返回"mall/order-detail"
my-orders.html-->>浏览器 : 渲染订单详情页
```

**图示来源**
- [ShoppingCartController.java](file://src/main/java/ltd/newbee/mall/controller/mall/ShoppingCartController.java#L107-L128)
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L67-L82)
- [order-settle.html](file://src/main/resources/templates/mall/order-settle.html)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L37-L158)
- [order-settle.html](file://src/main/resources/templates/mall/order-settle.html)
- [my-orders.html](file://src/main/resources/templates/mall/my-orders.html)

## 用户个人中心

用户个人中心功能由`PersonalController`控制器实现，包含用户登录、注册、信息更新等核心功能。该控制器通过`@PostMapping`注解处理表单提交，并使用`ResultGenerator`返回JSON格式的响应结果。

```mermaid
flowchart TD
Start([用户访问]) --> CheckPath{"路径判断"}
CheckPath --> |/personal| ShowPersonal["显示个人中心"]
CheckPath --> |/login| ShowLogin["显示登录页"]
CheckPath --> |/register| ShowRegister["显示注册页"]
CheckPath --> |/logout| Logout["执行登出"]
ShowPersonal --> personal.html
ShowLogin --> login.html
ShowRegister --> register.html
Logout --> ClearSession["清除session"]
ClearSession --> RedirectLogin["重定向到登录页"]
login.html --> SubmitLogin["提交登录表单"]
SubmitLogin --> PersonalController["PersonalController.login()"]
PersonalController --> ValidateCaptcha["验证验证码"]
ValidateCaptcha --> |失败| ReturnError["返回验证码错误"]
ValidateCaptcha --> |成功| CallUserService["调用newBeeMallUserService.login()"]
CallUserService --> |成功| RemoveCaptcha["清除验证码"]
RemoveCaptcha --> ReturnSuccess["返回成功结果"]
CallUserService --> |失败| ReturnFail["返回失败结果"]
register.html --> SubmitRegister["提交注册表单"]
SubmitRegister --> PersonalController["PersonalController.register()"]
PersonalController --> ValidateRegisterCaptcha["验证注册验证码"]
ValidateRegisterCaptcha --> |失败| ReturnRegisterError["返回验证码错误"]
ValidateRegisterCaptcha --> |成功| CallUserServiceRegister["调用newBeeMallUserService.register()"]
CallUserServiceRegister --> |成功| RemoveRegisterCaptcha["清除验证码"]
RemoveRegisterCaptcha --> ReturnRegisterSuccess["返回成功结果"]
CallUserServiceRegister --> |失败| ReturnRegisterFail["返回失败结果"]
```

**图示来源**
- [PersonalController.java](file://src/main/java/ltd/newbee/mall/controller/mall/PersonalController.java)
- [login.html](file://src/main/resources/templates/mall/login.html)
- [register.html](file://src/main/resources/templates/mall/register.html)

**章节来源**
- [PersonalController.java](file://src/main/java/ltd/newbee/mall/controller/mall/PersonalController.java#L28-L136)

## 视图对象(VO)作用

视图对象(VO)在前后端数据交互中起着关键作用，主要用于封装和转换数据，避免直接暴露实体类给前端。系统中定义了多种VO类，如`NewBeeMallGoodsDetailVO`、`NewBeeMallShoppingCartItemVO`等，这些VO类只包含前端需要的属性，提高了数据传输的安全性和效率。

```mermaid
classDiagram
class NewBeeMallGoodsDetailVO {
+Long goodsId
+String goodsName
+String goodsIntro
+String goodsCoverImg
+String[] goodsCarouselList
+Integer sellingPrice
+Integer originalPrice
+String goodsDetailContent
+getGoodsId() Long
+setGoodsId(Long) void
+getGoodsName() String
+setGoodsName(String) void
+getGoodsIntro() String
+setGoodsIntro(String) void
+getGoodsCoverImg() String
+setGoodsCoverImg(String) void
+getGoodsCarouselList() String[]
+setGoodsCarouselList(String[]) void
+getSellingPrice() Integer
+setSellingPrice(Integer) void
+getOriginalPrice() Integer
+setOriginalPrice(Integer) void
+getGoodsDetailContent() String
+setGoodsDetailContent(String) void
}
class NewBeeMallShoppingCartItemVO {
+Long cartItemId
+Long goodsId
+Integer goodsCount
+String goodsName
+String goodsCoverImg
+Integer sellingPrice
+getCartItemId() Long
+setCartItemId(Long) void
+getGoodsId() Long
+setGoodsId(Long) void
+getGoodsCount() Integer
+setGoodsCount(Integer) void
+getGoodsName() String
+setGoodsName(String) void
+getGoodsCoverImg() String
+setGoodsCoverImg(String) void
+getSellingPrice() Integer
+setSellingPrice(Integer) void
}
class NewBeeMallIndexCategoryVO {
+Long categoryId
+Byte categoryLevel
+String categoryName
+SecondLevelCategoryVO[] secondLevelCategoryVOS
+getCategoryId() Long
+setCategoryId(Long) void
+getCategoryLevel() Byte
+setCategoryLevel(Byte) void
+getCategoryName() String
+setCategoryName(String) void
+getSecondLevelCategoryVOS() SecondLevelCategoryVO[]
+setSecondLevelCategoryVOS(SecondLevelCategoryVO[]) void
}
NewBeeMallGoodsDetailVO --> NewBeeMallGoods : "数据来源"
NewBeeMallShoppingCartItemVO --> NewBeeMallShoppingCartItem : "数据来源"
NewBeeMallIndexCategoryVO --> GoodsCategory : "数据来源"
```

**图示来源**
- [NewBeeMallGoodsDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallGoodsDetailVO.java)
- [NewBeeMallShoppingCartItemVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallShoppingCartItemVO.java)
- [NewBeeMallIndexCategoryVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallIndexCategoryVO.java)

**章节来源**
- [NewBeeMallGoodsDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallGoodsDetailVO.java)
- [NewBeeMallShoppingCartItemVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallShoppingCartItemVO.java)
- [NewBeeMallIndexCategoryVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallIndexCategoryVO.java)

## 拦截器安全机制

系统通过`NewBeeMallLoginInterceptor`拦截器保障用户会话安全，确保只有登录用户才能访问受保护的资源。该拦截器在`NeeBeeMallWebMvcConfigurer`配置类中注册，对特定路径进行拦截。

```mermaid
sequenceDiagram
participant 浏览器
participant NewBeeMallLoginInterceptor
participant HttpSession
participant 受保护资源
浏览器->>NewBeeMallLoginInterceptor : 请求受保护资源
NewBeeMallLoginInterceptor->>HttpSession : 检查MALL_USER_SESSION_KEY
HttpSession-->>NewBeeMallLoginInterceptor : 返回session值
alt 未登录
NewBeeMallLoginInterceptor->>浏览器 : 重定向到/login
else 已登录
NewBeeMallLoginInterceptor->>受保护资源 : 放行请求
受保护资源-->>浏览器 : 返回响应
end
```

**图示来源**
- [NewBeeMallLoginInterceptor.java](file://src/main/java/ltd/newbee/mall/interceptor/NewBeeMallLoginInterceptor.java)
- [NeeBeeMallWebMvcConfigurer.java](file://src/main/java/ltd/newbee/mall/config/NeeBeeMallWebMvcConfigurer.java)

**章节来源**
- [NewBeeMallLoginInterceptor.java](file://src/main/java/ltd/newbee/mall/interceptor/NewBeeMallLoginInterceptor.java#L28-L38)
- [NeeBeeMallWebMvcConfigurer.java](file://src/main/java/ltd/newbee/mall/config/NeeBeeMallWebMvcConfigurer.java#L31-L59)