# 订单管理

<cite>
**本文档引用的文件**  
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java)
- [NewBeeMallOrderService.java](file://src/main/java/ltd/newbee/mall/service/NewBeeMallOrderService.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)
- [NewBeeMallOrderListVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderListVO.java)
- [NewBeeMallOrderDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderDetailVO.java)
- [NumberUtil.java](file://src/main/java/ltd/newbee/mall/util/NumberUtil.java)
- [NewBeeMallOrder.java](file://src/main/java/ltd/newbee/mall/entity/NewBeeMallOrder.java)
- [NewBeeMallOrderItem.java](file://src/main/java/ltd/newbee/mall/entity/NewBeeMallOrderItem.java)
- [NewBeeMallOrderMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderMapper.java)
- [NewBeeMallOrderItemMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderItemMapper.java)
- [PayStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/PayStatusEnum.java)
- [PayTypeEnum.java](file://src/main/java/ltd/newbee/mall/common/PayTypeEnum.java)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [订单创建流程](#订单创建流程)
4. [订单结算流程](#订单结算流程)
5. [订单查询功能](#订单查询功能)
6. [订单状态机管理](#订单状态机管理)
7. [订单号生成策略](#订单号生成策略)
8. [价格计算逻辑](#价格计算逻辑)
9. [订单数据VO结构](#订单数据vo结构)
10. [订单超时处理](#订单超时处理)
11. [支付状态同步](#支付状态同步)
12. [订单取消流程](#订单取消流程)
13. [数据一致性排查](#数据一致性排查)

## 项目结构

```mermaid
graph TB
subgraph "控制器层"
OrderController["OrderController<br/>订单控制层"]
ShoppingCartController["ShoppingCartController<br/>购物车控制层"]
end
subgraph "服务层"
OrderService["NewBeeMallOrderService<br/>订单服务接口"]
OrderServiceImpl["NewBeeMallOrderServiceImpl<br/>订单服务实现"]
end
subgraph "数据访问层"
OrderMapper["NewBeeMallOrderMapper<br/>订单数据访问"]
OrderItemMapper["NewBeeMallOrderItemMapper<br/>订单项数据访问"]
GoodsMapper["NewBeeMallGoodsMapper<br/>商品数据访问"]
end
subgraph "实体与VO层"
OrderEntity["NewBeeMallOrder<br/>订单实体"]
OrderItemEntity["NewBeeMallOrderItem<br/>订单项实体"]
OrderListVO["NewBeeMallOrderListVO<br/>订单列表视图对象"]
OrderDetailVO["NewBeeMallOrderDetailVO<br/>订单详情视图对象"]
end
subgraph "枚举与工具类"
OrderStatusEnum["NewBeeMallOrderStatusEnum<br/>订单状态枚举"]
PayStatusEnum["PayStatusEnum<br/>支付状态枚举"]
PayTypeEnum["PayTypeEnum<br/>支付类型枚举"]
NumberUtil["NumberUtil<br/>工具类"]
end
OrderController --> OrderServiceImpl
OrderServiceImpl --> OrderMapper
OrderServiceImpl --> OrderItemMapper
OrderServiceImpl --> GoodsMapper
OrderMapper --> OrderEntity
OrderItemMapper --> OrderItemEntity
OrderServiceImpl --> OrderListVO
OrderServiceImpl --> OrderDetailVO
OrderController --> OrderListVO
OrderController --> OrderDetailVO
OrderServiceImpl --> OrderStatusEnum
OrderServiceImpl --> PayStatusEnum
OrderServiceImpl --> PayTypeEnum
OrderServiceImpl --> NumberUtil
```

**图示来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java)
- [NewBeeMallOrderService.java](file://src/main/java/ltd/newbee/mall/service/NewBeeMallOrderService.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)
- [NewBeeMallOrderMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderMapper.java)
- [NewBeeMallOrderItemMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderItemMapper.java)
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)
- [PayStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/PayStatusEnum.java)
- [PayTypeEnum.java](file://src/main/java/ltd/newbee/mall/common/PayTypeEnum.java)
- [NumberUtil.java](file://src/main/java/ltd/newbee/mall/util/NumberUtil.java)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java)
- [NewBeeMallOrderService.java](file://src/main/java/ltd/newbee/mall/service/NewBeeMallOrderService.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)

## 核心组件

订单管理功能的核心组件包括订单控制器（OrderController）、订单服务（NewBeeMallOrderService）、订单数据访问层（NewBeeMallOrderMapper）以及相关的视图对象（VO）和枚举类。系统采用典型的三层架构，控制器层负责处理HTTP请求，服务层实现核心业务逻辑，数据访问层负责与数据库交互。

订单创建、结算和查询等核心功能通过事务管理确保数据一致性，特别是在库存扣减和订单生成过程中。系统使用MyBatis作为ORM框架，通过Mapper接口与数据库进行交互。

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java)
- [NewBeeMallOrderService.java](file://src/main/java/ltd/newbee/mall/service/NewBeeMallOrderService.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)

## 订单创建流程

订单创建流程从购物车提交开始，通过`saveOrder`方法实现完整的事务处理。该流程包括收货地址验证、购物车数据获取、商品状态检查、库存验证、购物车项删除、库存扣减、订单号生成、订单创建和订单项创建等步骤。

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 控制器 as "OrderController"
participant 服务层 as "NewBeeMallOrderService"
participant 购物车服务 as "NewBeeMallShoppingCartService"
participant 商品服务 as "NewBeeMallGoodsService"
participant 订单Mapper as "NewBeeMallOrderMapper"
participant 订单项Mapper as "NewBeeMallOrderItemMapper"
participant 商品Mapper as "NewBeeMallGoodsMapper"
用户->>控制器 : 提交购物车创建订单
控制器->>控制器 : 验证用户收货地址
控制器->>购物车服务 : 获取用户购物车项
购物车服务-->>控制器 : 返回购物车项列表
控制器->>服务层 : 调用saveOrder方法
服务层->>商品服务 : 查询商品信息
商品服务-->>服务层 : 返回商品列表
服务层->>服务层 : 检查商品是否下架
服务层->>服务层 : 验证商品库存
服务层->>购物车Mapper : 批量删除购物车项
购物车Mapper-->>服务层 : 删除结果
服务层->>商品Mapper : 批量扣减商品库存
商品Mapper-->>服务层 : 库存更新结果
服务层->>服务层 : 生成订单号
服务层->>服务层 : 计算订单总价
服务层->>订单Mapper : 插入订单记录
订单Mapper-->>服务层 : 订单ID
服务层->>服务层 : 创建订单项列表
服务层->>订单项Mapper : 批量插入订单项
订单项Mapper-->>服务层 : 插入结果
服务层-->>控制器 : 返回订单号
控制器-->>用户 : 重定向到订单详情页
```

**图示来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L67-L83)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L186-L262)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L67-L83)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L186-L262)

## 订单结算流程

订单结算流程涉及支付方式选择、支付页面跳转和支付成功处理。用户在订单详情页选择支付方式后，系统验证订单状态和用户权限，然后跳转到相应的支付页面。支付成功后，通过回调接口更新订单状态。

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 控制器 as "OrderController"
participant 服务层 as "NewBeeMallOrderService"
participant 订单Mapper as "NewBeeMallOrderMapper"
用户->>控制器 : 选择支付方式
控制器->>控制器 : 验证用户权限
控制器->>服务层 : 获取订单信息
服务层->>订单Mapper : 查询订单
订单Mapper-->>服务层 : 返回订单
服务层-->>控制器 : 返回订单信息
控制器->>控制器 : 验证订单状态(待支付)
控制器-->>用户 : 显示支付选择页面
用户->>控制器 : 选择具体支付方式
控制器->>控制器 : 验证用户权限
控制器->>服务层 : 获取订单信息
服务层->>订单Mapper : 查询订单
订单Mapper-->>服务层 : 返回订单
服务层-->>控制器 : 返回订单信息
控制器->>控制器 : 验证订单状态(待支付)
控制器-->>用户 : 跳转到支付宝/微信支付页面
用户->>控制器 : 支付成功回调
控制器->>服务层 : 调用paySuccess
服务层->>订单Mapper : 查询订单
订单Mapper-->>服务层 : 返回订单
服务层->>服务层 : 验证订单状态(待支付)
服务层->>服务层 : 更新订单状态为已支付
服务层->>服务层 : 设置支付类型和支付时间
服务层->>订单Mapper : 更新订单
订单Mapper-->>服务层 : 更新结果
服务层-->>控制器 : 返回成功结果
控制器-->>用户 : 返回支付成功结果
```

**图示来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L109-L157)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L374-L394)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L109-L157)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L374-L394)

## 订单查询功能

订单查询功能包括订单详情查询和订单列表查询，通过不同的VO对象为不同页面提供定制化数据。订单详情查询返回完整的订单信息，包括订单项列表；订单列表查询返回分页的订单摘要信息。

```mermaid
flowchart TD
Start([开始]) --> OrderList["订单列表查询"]
OrderList --> PageQuery["创建分页查询参数"]
PageQuery --> OrderMapper["调用getMyOrders方法"]
OrderMapper --> DBQuery["查询订单总数和列表"]
DBQuery --> VOConvert["转换为NewBeeMallOrderListVO"]
VOConvert --> StatusConvert["设置订单状态中文显示"]
StatusConvert --> ItemQuery["查询订单项"]
ItemQuery --> ItemGroup["按订单ID分组订单项"]
ItemGroup --> ItemConvert["转换为NewBeeMallOrderItemVO"]
ItemConvert --> SetItems["设置订单项到VO"]
SetItems --> ReturnResult["返回分页结果"]
ReturnResult --> End([结束])
Start --> OrderDetail["订单详情查询"]
OrderDetail --> OrderNoQuery["根据订单号查询订单"]
OrderNoQuery --> PermissionCheck["验证用户权限"]
PermissionCheck --> ItemQueryDetail["查询订单项"]
ItemQueryDetail --> ItemConvertDetail["转换为NewBeeMallOrderItemVO"]
ItemConvertDetail --> DetailVOConvert["创建NewBeeMallOrderDetailVO"]
DetailVOConvert --> SetStatusString["设置状态中文显示"]
SetStatusString --> SetPayTypeString["设置支付类型中文显示"]
SetPayTypeString --> ReturnDetail["返回详情VO"]
ReturnDetail --> End
```

**图示来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L52-L65)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L294-L323)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L264-L287)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L52-L65)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L264-L323)

## 订单状态机管理

订单状态机通过NewBeeMallOrderStatusEnum枚举类实现，定义了订单的完整生命周期。系统通过状态码控制订单状态的转换，确保业务流程的正确性。

```mermaid
stateDiagram-v2
[*] --> 待支付
待支付 --> 已支付 : 支付成功
已支付 --> 配货完成 : 配货完成
配货完成 --> 出库成功 : 出库成功
出库成功 --> 交易成功 : 确认收货
待支付 --> 手动关闭 : 用户取消
待支付 --> 超时关闭 : 超时未支付
待支付 --> 商家关闭 : 商家关闭
已支付 --> 商家关闭 : 商家关闭
配货完成 --> 商家关闭 : 商家关闭
出库成功 --> 商家关闭 : 商家关闭
state "待支付" as ORDER_PRE_PAY
state "已支付" as ORDER_PAID
state "配货完成" as ORDER_PACKAGED
state "出库成功" as ORDER_EXPRESS
state "交易成功" as ORDER_SUCCESS
state "手动关闭" as ORDER_CLOSED_BY_MALLUSER
state "超时关闭" as ORDER_CLOSED_BY_EXPIRED
state "商家关闭" as ORDER_CLOSED_BY_JUDGE
```

**图示来源**
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)

**章节来源**
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)

## 订单号生成策略

订单号生成策略通过NumberUtil工具类的genOrderNo方法实现，采用时间戳加随机数的方式生成唯一订单号，确保订单号的全局唯一性和可追溯性。

```mermaid
flowchart TD
Start([开始]) --> GetTimestamp["获取当前时间戳"]
GetTimestamp --> CreateBuffer["创建StringBuffer"]
CreateBuffer --> AppendTimestamp["将时间戳添加到缓冲区"]
AppendTimestamp --> GenRandom["生成4位随机数"]
GenRandom --> AppendRandom["将随机数添加到缓冲区"]
AppendRandom --> ReturnOrderNo["返回订单号字符串"]
ReturnOrderNo --> End([结束])
```

**图示来源**
- [NumberUtil.java](file://src/main/java/ltd/newbee/mall/util/NumberUtil.java#L53-L58)

**章节来源**
- [NumberUtil.java](file://src/main/java/ltd/newbee/mall/util/NumberUtil.java#L53-L58)

## 价格计算逻辑

订单价格计算逻辑在订单创建时执行，系统遍历购物车中的每个商品项，将商品销售价格乘以购买数量，累加得到订单总价。系统在计算前会验证商品是否下架和库存是否充足。

```mermaid
flowchart TD
Start([开始]) --> InitTotal["初始化总价为0"]
InitTotal --> LoopItems["遍历购物车项"]
LoopItems --> GetPrice["获取商品销售价格"]
GetPrice --> GetCount["获取商品数量"]
GetCount --> CalculateItem["计算单项总价<br/>= 销售价格 × 数量"]
CalculateItem --> AddToTotal["累加到订单总价"]
AddToTotal --> CheckNext["是否有下一个商品项?"]
CheckNext --> |是| LoopItems
CheckNext --> |否| ValidateTotal["验证总价大于0"]
ValidateTotal --> |是| ReturnTotal["返回订单总价"]
ValidateTotal --> |否| ThrowError["抛出价格错误异常"]
ReturnTotal --> End([结束])
ThrowError --> End
```

**图示来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L220-L234)

**章节来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L220-L234)

## 订单数据VO结构

订单系统使用两种视图对象（VO）为不同页面提供定制化数据：NewBeeMallOrderListVO用于订单列表页面，NewBeeMallOrderDetailVO用于订单详情页面。

```mermaid
classDiagram
class NewBeeMallOrderListVO {
+Long orderId
+String orderNo
+Integer totalPrice
+Byte payType
+Byte orderStatus
+String orderStatusString
+String userAddress
+Date createTime
+NewBeeMallOrderItemVO[] newBeeMallOrderItemVOS
+getOrderId() Long
+setOrderId(Long) void
+getOrderNo() String
+setOrderNo(String) void
+getTotalPrice() Integer
+setTotalPrice(Integer) void
+getPayType() Byte
+setPayType(Byte) void
+getOrderStatus() Byte
+setOrderStatus(Byte) void
+getOrderStatusString() String
+setOrderStatusString(String) void
+getUserAddress() String
+setUserAddress(String) void
+getCreateTime() Date
+setCreateTime(Date) void
+getNewBeeMallOrderItemVOS() NewBeeMallOrderItemVO[]
+setNewBeeMallOrderItemVOS(NewBeeMallOrderItemVO[]) void
}
class NewBeeMallOrderDetailVO {
+String orderNo
+Integer totalPrice
+Byte payStatus
+String payStatusString
+Byte payType
+String payTypeString
+Date payTime
+Byte orderStatus
+String orderStatusString
+String userAddress
+Date createTime
+NewBeeMallOrderItemVO[] newBeeMallOrderItemVOS
+getOrderNo() String
+setOrderNo(String) void
+getTotalPrice() Integer
+setTotalPrice(Integer) void
+getPayStatus() Byte
+setPayStatus(Byte) void
+getPayType() Byte
+setPayType(Byte) void
+getPayTime() Date
+setPayTime(Date) void
+getOrderStatus() Byte
+setOrderStatus(Byte) void
+getUserAddress() String
+setUserAddress(String) void
+getCreateTime() Date
+setCreateTime(Date) void
+getPayStatusString() String
+setPayStatusString(String) void
+getPayTypeString() String
+setPayTypeString(String) void
+getOrderStatusString() String
+setOrderStatusString(String) void
+getNewBeeMallOrderItemVOS() NewBeeMallOrderItemVO[]
+setNewBeeMallOrderItemVOS(NewBeeMallOrderItemVO[]) void
}
NewBeeMallOrderListVO --> NewBeeMallOrderItemVO : "包含"
NewBeeMallOrderDetailVO --> NewBeeMallOrderItemVO : "包含"
```

**图示来源**
- [NewBeeMallOrderListVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderListVO.java)
- [NewBeeMallOrderDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderDetailVO.java)

**章节来源**
- [NewBeeMallOrderListVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderListVO.java)
- [NewBeeMallOrderDetailVO.java](file://src/main/java/ltd/newbee/mall/controller/vo/NewBeeMallOrderDetailVO.java)

## 订单超时处理

订单超时处理通过系统定时任务或外部监控服务实现，当订单处于"待支付"状态超过规定时间（通常为30分钟）时，系统自动将订单状态更新为"超时关闭"，并恢复相应的商品库存。

```mermaid
flowchart TD
Start([开始]) --> QueryTimeout["查询超时订单"]
QueryTimeout --> FilterStatus["筛选待支付状态订单"]
FilterStatus --> CheckTime["检查创建时间是否超时"]
CheckTime --> |是| ProcessOrder["处理超时订单"]
CheckTime --> |否| SkipOrder["跳过订单"]
ProcessOrder --> UpdateStatus["更新订单状态为超时关闭"]
UpdateStatus --> RecoverStock["恢复商品库存"]
RecoverStock --> UpdateTime["更新订单更新时间"]
UpdateTime --> LogAction["记录操作日志"]
LogAction --> NextOrder["处理下一个订单"]
SkipOrder --> NextOrder
NextOrder --> |还有订单| QueryTimeout
NextOrder --> |无订单| End([结束])
```

**图示来源**
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L147-L183)

**章节来源**
- [NewBeeMallOrderStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/NewBeeMallOrderStatusEnum.java)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L147-L183)

## 支付状态同步

支付状态同步通过支付成功回调接口实现，当第三方支付平台完成支付后，会调用系统的paySuccess接口，系统验证订单状态后更新支付相关信息。

```mermaid
sequenceDiagram
participant 支付平台 as "第三方支付平台"
participant 系统 as "新蜂商城系统"
participant 订单服务 as "NewBeeMallOrderService"
participant 订单Mapper as "NewBeeMallOrderMapper"
支付平台->>系统 : 支付成功回调请求
系统->>订单服务 : 调用paySuccess方法
订单服务->>订单Mapper : 查询订单信息
订单Mapper-->>订单服务 : 返回订单
订单服务->>订单服务 : 验证订单状态(必须为待支付)
订单服务->>订单服务 : 设置订单状态为已支付
订单服务->>订单服务 : 设置支付类型
订单服务->>订单服务 : 设置支付状态为支付成功
订单服务->>订单服务 : 设置支付时间
订单服务->>订单Mapper : 更新订单信息
订单Mapper-->>订单服务 : 返回更新结果
订单服务-->>系统 : 返回处理结果
系统-->>支付平台 : 返回成功响应
```

**图示来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L374-L394)
- [PayStatusEnum.java](file://src/main/java/ltd/newbee/mall/common/PayStatusEnum.java)
- [PayTypeEnum.java](file://src/main/java/ltd/newbee/mall/common/PayTypeEnum.java)

**章节来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L374-L394)

## 订单取消流程

订单取消流程允许用户在订单未完成前手动取消订单，系统会验证订单状态，更新订单状态为"手动关闭"，并恢复相应的商品库存。

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 控制器 as "OrderController"
participant 服务层 as "NewBeeMallOrderService"
participant 订单Mapper as "NewBeeMallOrderMapper"
用户->>控制器 : 发起取消订单请求
控制器->>控制器 : 获取用户会话信息
控制器->>服务层 : 调用cancelOrder方法
服务层->>订单Mapper : 查询订单信息
订单Mapper-->>服务层 : 返回订单
服务层->>服务层 : 验证用户权限(订单属于当前用户)
服务层->>服务层 : 验证订单状态(不能是已完成、已关闭等状态)
服务层->>服务层 : 更新订单状态为手动关闭
服务层->>服务层 : 恢复商品库存
服务层->>订单Mapper : 更新订单状态
订单Mapper-->>服务层 : 返回更新结果
服务层-->>控制器 : 返回处理结果
控制器-->>用户 : 返回取消结果
```

**图示来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L85-L95)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L325-L349)

**章节来源**
- [OrderController.java](file://src/main/java/ltd/newbee/mall/controller/mall/OrderController.java#L85-L95)
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java#L325-L349)

## 数据一致性排查

订单数据不一致问题可能出现在订单创建、支付状态更新或库存管理等环节。以下是常见的排查方法和解决方案。

```mermaid
flowchart TD
Start([开始]) --> IdentifyIssue["识别数据不一致问题"]
IdentifyIssue --> CheckOrder["检查订单状态不一致"]
CheckOrder --> |是| VerifyPayment["验证支付状态"]
VerifyPayment --> CompareStatus["对比系统状态与支付平台状态"]
CompareStatus --> UpdateStatus["同步最新状态"]
UpdateStatus --> LogIssue["记录问题日志"]
IdentifyIssue --> CheckStock["检查库存不一致"]
CheckStock --> |是| ReconcileStock["核对订单项与商品库存"]
ReconcileStock --> CalculateDiff["计算库存差异"]
CalculateDiff --> AdjustStock["调整库存数量"]
AdjustStock --> LogIssue
IdentifyIssue --> CheckAmount["检查金额不一致"]
CheckAmount --> |是| Recalculate["重新计算订单金额"]
Recalculate --> CompareAmount["对比原始金额与计算金额"]
CompareAmount --> CorrectAmount["修正金额"]
CorrectAmount --> LogIssue
IdentifyIssue --> CheckItems["检查订单项不一致"]
CheckItems --> |是| ValidateItems["验证订单项完整性"]
ValidateItems --> AddMissing["补充缺失订单项"]
AddMissing --> LogIssue
LogIssue --> Preventive["实施预防措施"]
Preventive --> ImplementLock["实现数据库行级锁"]
ImplementLock --> AddTransaction["添加事务管理"]
AddTransaction --> CreateAudit["创建审计日志"]
CreateAudit --> MonitorSystem["监控系统状态"]
MonitorSystem --> End([结束])
```

**图示来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)
- [NewBeeMallOrderMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderMapper.java)
- [NewBeeMallOrderItemMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderItemMapper.java)

**章节来源**
- [NewBeeMallOrderServiceImpl.java](file://src/main/java/ltd/newbee/mall/service/impl/NewBeeMallOrderServiceImpl.java)
- [NewBeeMallOrderMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderMapper.java)
- [NewBeeMallOrderItemMapper.java](file://src/main/java/ltd/newbee/mall/dao/NewBeeMallOrderItemMapper.java)